<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Keuangan DTI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    h1, h3 { text-align: center; }

    .container {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }

    button {
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-admin { background: #34495e; color: #fff; }
    .btn-add { background: #2ecc71; color: #fff; }
    .btn-delete { background: #e74c3c; color: #fff; }

    form {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    input {
      padding: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th { background: #f1f1f1; }

    .summary {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-weight: bold;
    }

    #loginBox {
      display: none;
      max-width: 300px;
      margin: 40px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }

    @media (max-width: 768px) {
      form { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<div class="container">
  <h1>ðŸ“Š Pencatat Keuangan DTI</h1>

  <!-- BUTTON ADMIN LOGIN -->
  <div style="text-align:right">
    <button class="btn-admin" onclick="showLogin()">Login Admin</button>
  </div>

  <!-- LOGIN ADMIN -->
  <div id="loginBox">
    <h3>Login Admin</h3>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button class="btn-admin" onclick="login()">Login</button>
    <p id="loginMsg" style="color:red;text-align:center"></p>
  </div>

  <!-- FORM ADMIN -->
  <form id="financeForm" style="display:none">
    <input type="date" id="timelapse" required>
    <input type="number" id="input" placeholder="Input" value="0">
    <input type="number" id="output" placeholder="Output" value="0">
    <input type="text" id="description" placeholder="Deskripsi">
    <button class="btn-add" type="submit">Tambah</button>
  </form>

  <!-- SUMMARY -->
  <div class="summary">
    <div>Total Input: <span id="totalInput">0</span></div>
    <div>Total Output: <span id="totalOutput">0</span></div>
    <div>Saldo: <span id="saldo">0</span></div>
  </div>

  <!-- TABLE -->
  <table>
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Input</th>
        <th>Output</th>
        <th>Deskripsi</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="dataTable"></tbody>
  </table>
</div>

<script>
/************************************************
 * CONFIG
 ************************************************/
const API_URL =
  'https://script.google.com/macros/s/AKfycbwVdahYSS-hmo0KIuxigPQ0QvlC794jLcEbtBITj5o2fkoT0c54Y5CfoAxOcVIil3dS/exec';

let IS_ADMIN = false;

/************************************************
 * LOGIN
 ************************************************/
function showLogin() {
  document.getElementById('loginBox').style.display = 'block';
}

function login() {
  fetch(API_URL + '?action=login', {
    method: 'POST',
    body: JSON.stringify({
      username: username.value,
      password: password.value
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === 'success') {
      IS_ADMIN = true;
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('financeForm').style.display = 'grid';
      fetchData();
    } else {
      loginMsg.textContent = res.message;
    }
  });
}

/************************************************
 * DATA
 ************************************************/
const table = document.getElementById('dataTable');
const totalInputEl = document.getElementById('totalInput');
const totalOutputEl = document.getElementById('totalOutput');
const saldoEl = document.getElementById('saldo');

document.getElementById('financeForm')
  .addEventListener('submit', addData);

function fetchData() {
  fetch(API_URL)
    .then(res => res.json())
    .then(res => {
      table.innerHTML = '';
      let totalIn = 0;
      let totalOut = 0;

      res.data.forEach(item => {
        totalIn += Number(item.Input);
        totalOut += Number(item.Output);

        table.innerHTML += `
          <tr>
            <td>${item.Timelapse}</td>
            <td>${item.Input}</td>
            <td>${item.Output}</td>
            <td>${item.Description}</td>
            <td>
              ${IS_ADMIN
                ? `<button class="btn-delete"
                     onclick="deleteData(${item.row})">Hapus</button>`
                : '-'}
            </td>
          </tr>
        `;
      });

      totalInputEl.textContent = totalIn;
      totalOutputEl.textContent = totalOut;
      saldoEl.textContent = totalIn - totalOut;
    });
}

function addData(e) {
  e.preventDefault();

  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      Timelapse: timelapse.value,
      Input: input.value,
      Output: output.value,
      Description: description.value,
      role: 'admin'
    })
  }).then(() => {
    e.target.reset();
    fetchData();
  });
}

function deleteData(row) {
  if (!confirm('Hapus data ini?')) return;

  fetch(API_URL, {
    method: 'DELETE',
    body: JSON.stringify({
      row: row,
      role: 'admin'
    })
  }).then(fetchData);
}

// INIT (USER MODE)
fetchData();
</script>

</body>
</html>
